# TSLA/TSLL Portfolio Backtest Optimization

이 프로그램은 TSLA와 TSLL 주식으로 구성된 포트폴리오를 최적화하기 위해 과거 데이터를 분석하고, **그리드 서치**, **유전 알고리즘**, **베이지안 최적화**를 사용하여 최적의 파라미터를 탐색합니다. 최종적으로 가장 높은 포트폴리오 가치를 제공하는 파라미터를 선택하여 `optimal_params.json` 파일에 저장합니다.

## Overview

이 프로젝트는 TSLA와 TSLL 주식의 과거 데이터를 활용하여 포트폴리오 성과를 백테스트하고, 다양한 시장 지표를 기반으로 포트폴리오 비중을 조정하는 파라미터를 최적화합니다. 최적화된 파라미터는 포트폴리오의 수익률을 극대화하는 데 사용되며, 이를 위해 세 가지 최적화 기법을 제공합니다.

## Features

- **시장 지표 계산**: Fear & Greed Index, 일일/주간 RSI, SMA(단순 이동 평균), 볼린저 밴드, MACD, 거래량 변화, ATR(평균 진폭 범위) 등.
- **백테스팅**: 주어진 파라미터를 사용하여 과거 데이터에 대한 포트폴리오 성과를 시뮬레이션.
- **최적화 기법**:
  - **그리드 서치**: 모든 파라미터 조합을 탐색.
  - **유전 알고리즘**: 진화론적 접근으로 최적해 탐색.
  - **베이지안 최적화**: 확률적 모델로 효율적 탐색.
- **진행 상황 모니터링**: 실시간 진행 바와 예상 소요 시간 표시.
- **결과 저장**: 최적 파라미터를 JSON 파일로 저장.

## Installation

이 프로그램은 Python 3.6 이상에서 실행됩니다. 필요한 라이브러리를 설치하려면 다음 명령어를 실행하세요.

```bash
pip install pandas numpy deap bayesian-optimization tqdm scipy
```

## Usage

### 1. 데이터 파일 준비

다음 세 개의 CSV 파일이 필요합니다.
- `fear_greed_2years.csv`: Fear & Greed Index 데이터.
- `TSLA-history-2y.csv`: TSLA 주가 데이터.
- `TSLL-history-2y.csv`: TSLL 주가 데이터.
파일은 프로젝트 디렉토리에 저장해야 하며, 자세한 형식은 **Requirements** 섹션을 참조하세요.

### 2. 프로그램 실행

터미널에서 다음 명령어를 실행합니다.
```bash
python3 backtest.py
```
- 프로그램은 데이터를 로드하고 전처리한 후, 세 가지 최적화 기법(그리드 서치, 유전 알고리즘, 베이지안 최적화)을 순차적으로 실행합니다.
- 실행 중 진행 상황이 실시간으로 표시됩니다.

### 3. 출력 확인

각 최적화 기법의 진행 상황과 결과가 콘솔에 출력됩니다.
최종적으로 최적의 파라미터와 포트폴리오 가치가 `optimal_params.json` 파일에 저장됩니다.

## Requirements

`fear_greed_2years.csv`
- **설명**: Fear & Greed Index 데이터.
- **필수 열**:
  - `date`: 날짜 (형식: `%m/%d/%Y`).
  - `y`: Fear & Greed Index 값 (숫자).
- **생성 방법**
  ```bash
  python3 fear_greed.py
  ```
  
`TSLA-history-2y.csv`
- **설명**: TSLA 주가 데이터.
- **필수 열**:
  - `Date`: 날짜 (형식: `%m/%d/%Y`).
  - `Close`: 종가.
  - `High`: 고가.
  - `Low`: 저가.
  - `Volume`: 거래량 (쉼표 포함 문자열, 예: "1,234,567").
- **생성 방법**
  ```bash
  python3 getdata.py --ticker=TSLA
  ```
  
`TSLL-history-2y.csv`
- **설명**: TSLL 주가 데이터.
- **필수 열**: 위와 동일 (`TSLL_` 접두사가 내부적으로 추가됨).
- **생성 방법**
  ```bash
  python3 getdata.py --ticker=TSLL
  ```
  
### 데이터 전처리
- 날짜는 `parse_dates`와 `date_format='%m/%d/%Y'`로 처리됩니다.
- `Volume` 열의 쉼표는 제거되고 float로 변환됩니다.
- 결측치는 제거되며, RSI, SMA, MACD, 볼린저 밴드, ATR 등이 계산됩니다.

## 최적화 알고리즘

### 1. 그리드 서치 (Grid Search)

- **설명**: 모든 가능한 파라미터 조합을 탐색하여 최적의 조합을 찾습니다.
- **파라미터 그리드**:
  - `daily_rsi_buy`: [20, 25, 30, 35, 40]
  - `daily_rsi_sell`: [60, 65, 70, 75, 80]
  - `weekly_rsi_buy`: [30, 35, 40, 45, 50]
  - `weekly_rsi_sell`: [50, 55, 60, 65, 70]
  - `fg_buy`: [20, 30, 40, 50, 60]
  - `fg_sell`: [60, 65, 70, 75, 80]
  - `volume_change_buy`: [0.05, 0.1, 0.15, 0.2]
  - `volume_change_sell`: [-0.2, -0.15, -0.1, -0.05]
  - `w_buy`: [0.5, 1.0, 1.5, 2.0, 2.5]
  - `w_sell`: [0.5, 1.0, 1.5, 2.0, 2.5]
- **총 조합 수**: 625,000개 (5^10).
- **특징**: 철저하지만 계산 비용이 높음.

### 2. 유전 알고리즘 (Genetic Algorithm)

- **설명**: 진화론적 접근으로 개체군을 생성하고 교차 및 돌연변이를 통해 최적해를 탐색합니다.
- **파라미터 범위**:
  - `daily_rsi_buy`: (20, 40)
  - `daily_rsi_sell`: (60, 80)
  - `weekly_rsi_buy`: (30, 50)
  - `weekly_rsi_sell`: (50, 70)
  - `fg_buy`: (20, 60)
  - `fg_sell`: (60, 80)
  - `volume_change_buy`: (0.05, 0.2)
  - `volume_change_sell`: (-0.2, -0.05)
  - `w_buy`: (0.5, 2.5)
  - `w_sell`: (0.5, 2.5)
- **설정**:
  - 개체 수: 50
  - 세대 수: 40
  - 교차 확률: 0.5
  - 돌연변이 확률: 0.2
- **특징**: 효율적이며 복잡한 문제에 적합.

### 3. 베이지안 최적화 (Bayesian Optimization)

- **설명**: 확률적 모델을 사용하여 파라미터 공간에서 최적점을 효율적으로 탐색합니다.
- **파라미터 범위**: 유전 알고리즘과 동일.
- **설정**:
  - 초기 포인트: 5개
  - 반복 횟수: 25회
- **특징**: 계산 비용이 낮고 빠른 수렴.

### 진행 상황 모니터링

- `tqdm` **활용**: 각 최적화 기법에서 진행 바와 예상 소요 시간을 실시간으로 표시.
- **그리드 서치**:
  - 모든 조합(625,000개)에 대한 진행률과 남은 시간 출력.
- **유전 알고리즘**:
  - 40세대에 대한 진행률과 각 세대의 소요 시간 출력.
- **베이지안 최적화**:
  - 초기 포인트와 반복 진행 상황을 테이블 형식으로 출력.

## 출력 및 결과 해석

### 출력 예시
- **그리드 서치**:
  ```
  그리드 서치 시작: 총 625000개의 조합
  Grid Search Progress:   1%|▏         | 6250/625000 [00:10<16:40, 625.00it/s]
  진행 중: 6250/625000, 예상 남은 시간: 1000.00초
  ...
  그리드 서치 완료: 최적 파라미터 {'daily_rsi_buy': 30, ...}, 최종 포트폴리오 가치 150000.00
  ```
  
- **유전 알고리즘**:
  ```
  유전 알고리즘 시작: 40세대
  GA Progress:   2%|▎         | 1/40 [00:05<03:15,  5.00s/it]
  세대 1/40 완료, 소요 시간: 5.00초
  ...
  유전 알고리즘 완료: 최적 파라미터 {'daily_rsi_buy': 28.5, ...}, 최종 포트폴리오 가치 145000.00
  ```

- **베이지안 최적화**:
  ```
  베이지안 최적화 시작: 초기 포인트 5개, 반복 25회
  |   iter    |  target   | daily_... | ...
  ...
  베이지안 최적화 완료, 총 소요 시간: 120.00초
  최적 파라미터: {'daily_rsi_buy': 32.1, ...}, 최종 포트폴리오 가치: 148000.00
  ```

- **최종 결과**:
  ```
  최적의 방법: grid_search
  최적 파라미터: {'daily_rsi_buy': 30, ...}
  최종 포트폴리오 가치: $150000.00
  수익률: 50.00%
  최적 파라미터가 optimal_params.json에 저장되었습니다.

### 결과 해석
- **최적 파라미터**: 매수/매도 조건과 비중 조정 가중치.
- **포트폴리오 가치**: 초기 $100,000에서 최종 가치.
- **수익률**: 백테스트 기간 동안의 수익률(%).
